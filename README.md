# `semacaulk-precompute`

`semacaulk-updater` is a long-running process which monitors a Semacaulk
contract, precomputes witness data upon insertions, and updates a Blyss bucket.

## Getting started

Clone this repository and fetch submodules:

```bash
git clone git@github.com:geometryresearch/semacaulk-precompute.git && \
cd semacaulk-precompute && \
git submodule update --init
```

Build the `quotient-pir` WASM files:

```bash
cd quotient-pir && \
cargo build --release && wasm-pack build --target nodejs
```

Navigate to the repository's root directory:

```bash
cd ..
``` 

Run the process:

```bash
node build/index.js -c 0x5fbdb2315678afecb367f032d93f642f64180aa3 -n 4 -m 1 -g ./config_10
```

In the above example, `0x5fbd...` is the Semacaulk contract address, and
`./config_10` is the path to a config file generated by
[`quotient-pir-config`](https://github.com/geometryresearch/quotient-pir-config).

## Using a larger Semacaulk instance

For convenience, this repository comes with `config_10`, which supports
Semacaulk instances of a maximum capacity of 2 ^ 10 = 1024. If you wish to
instantiate a larger Semacaulk instance, you 

First, clone the `quotient-pir-config` repository and build it.

```bash
git clone https://github.com/geometryresearch/quotient-pir-config.git && \
cd quotient-pir-config && \
cargo build --release
```

Run the `config` binary, specifying the log-2 capacity (e.g. 11 for 2048), a
path to a suitable .ptau file (see
[snarkjs](https://github.com/iden3/snarkjs/#7-prepare-phase-2)), and the path
to the desired config file to be written.

```bash
cargo run --release --bin config -- -l <LOG_2 CAPACITY> --ptau <PTAU FILE> --output <CONFIG OUTPUT PATH>
```

You can run `node build/index.js` as above with the `-g` flag st to the path to
the new config file.

## Deploying and inserting leaves to a contract

Semacaulk comes with a `client` binary which can be used to deploy a Semacaulk
instance to an Ethereum RPC.

To deploy a Semacaulk instance with a local Ethereum test chain (such as
avail or Hardhat) listening at localhost:8545, run the following in a Semacaulk
repository:

```bash
cargo run --release --bin client -- deploy --ptau ./11.ptau -l 10
```

The contract address will be printed to the console. With the default private
key on a fresh RPC node, the address should be
`0x5fbdb2315678afecb367f032d93f642f64180aa3`.

To insert an identity commitment (e.g. from a identity nullifier set to 0x1 and
an identity trapdoor set to 0x5), run:

```bash
cargo run --release --bin client -- insert --ptau 11.ptau -c 0x5fbdb2315678afecb367f032d93f642f64180aa3 -l 10 --id_nul 0x1 --id_trap 0x5
```

## Full demo

1. Generate config file using quotient-pir-config

```bash
git clone git@github.com:geometryresearch/quotient-pir-config.git
cd quotient-pir-config
cargo build --release
cargo run --release --bin config -- -l 10 --ptau 10.ptau --output ../config_10
cd ..
```

2. Build Semacaulk

```bash
git clone git@github.com:geometryresearch/semacaulk.git
cd semacaulk
git checkout feature/client
cargo build --release
```

3. Run Anvil in another terminal

```bash
anvil
```

4. Deploy Semacaulk

```bash
./target/release/client deploy --ptau 11.ptau
```

5. Insert an identity commitment

```bash
./target/release/client insert --ptau 11.ptau -n 0x1 -t 0x2 -l 10 -c 0x5fbdb2315678afecb367f032d93f642f64180aa3
```
6. Run a local Blyss server in another terminal

```bash
git clone git@github.com:blyssprivacy/sdk.git
cd sdk/lib/server
cargo run --release --bin server
```

7. Run semacaulk-precompute in another terminal

```bash
git clone git@github.com:geometryresearch/semacaulk-precompute.git
cd semacaulk-precompute
git submodule update --init
npm i
cd quotient-pir
cargo build --release && wasm-pack build --target nodejs
cd ..
node build/index.js -c 0x5fbdb2315678afecb367f032d93f642f64180aa3 -n 4 -m 1 -g ../config_10
```

8. Insert identity commitments in the semacaulk terminal

```bash
./target/release/client insert --ptau 11.ptau -n 0x3 -t 0x4 -l 10 -c 0x5fbdb2315678afecb367f032d93f642f64180aa3
./target/release/client insert --ptau 11.ptau -n 0x5 -t 0x6 -l 10 -c 0x5fbdb2315678afecb367f032d93f642f64180aa3
```

You should see the semacaulk-precompute program pick up on these identity commitments, update QuotientTracker, and update the local Blyss bucket.
